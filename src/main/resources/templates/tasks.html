<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Tasks</title>
    <link rel="stylesheet" th:href="@{/tasks.css}">
    <script src="/js/world-clock.js" defer></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" integrity="sha512-9usAa10IRO0HhonpyAIVpjrylPvoDwiPUiKdWk5t3PyolY1cOd4DSE0Ga+ri4AuTroPR5aQvXU9xC6qOPnzFeg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
</head>
<body>

<div th:replace="~{fragments :: sidebar}"></div>

<div class="container">
    <header class="main-header">
        <div class="header-left">
            <h1>Task Reminder</h1>
            <div class="header-right">
                <a href="/tasks/add" class="btn btn-primary">
                    <i class="fas fa-plus"></i> Add Task
                </a>
            </div>
    </header>

    <!-- Unified Search & Filter Section -->
    <div class="search-section">
        <form th:action="@{/tasks}" method="get" style="width: 100%; display: flex; flex-wrap: wrap; gap: 10px;">
            <!-- Search by Title -->
            <input type="text" name="keyword" th:value="${keyword}" placeholder="Search by title..." />

            <!-- Filter by Status -->
            <select name="status">
                <option value="">-- All Statuses --</option>
                <option th:each="s : ${statuses}"
                        th:value="${s}"
                        th:text="${s}"
                        th:selected="${s == status}">
                </option>
            </select>

            <!-- Filter by Priority -->
            <select name="priority">
                <option value="">-- All Priorities --</option>
                <option th:each="p : ${priorities}"
                        th:value="${p}"
                        th:text="${p}"
                        th:selected="${p == priority}">
                </option>
            </select>

            <!-- Filter by Due Date -->
            <input type="date" name="dueDate" th:value="${dueDate}" />

            <button type="submit" class="btn btn-primary"><i class="fas fa-search"></i> Filter</button>
            <a href="/tasks" class="btn btn-secondary" style="background-color: #95a5a6;">Clear</a>
        </form>
    </div>
    <div class="world-clock">
        <i class="fas fa-clock"></i>
        <span id="clock-label">Local</span> :
        <span id="clock-time">--:--:--</span>

        <select id="timezone-select">
            <option value="local">Local</option>
            <option value="Asia/Kolkata">India</option>
            <option value="UTC">UTC</option>
            <option value="America/New_York">New York</option>
            <option value="Europe/London">London</option>
            <option value="Asia/Tokyo">Tokyo</option>
        </select>
    </div>


    <nav class="view-options" style="margin-bottom: 20px;">
        <button type="button" class="btn btn-view-toggle active" data-view="table-view" onclick="switchView('table-view')"><i class="fas fa-table"></i> Table View</button>
        <button type="button" class="btn btn-view-toggle" data-view="card-view" onclick="switchView('card-view')"><i class="fas fa-th-large"></i> Card View</button>
        <button type="button" class="btn btn-view-toggle" data-view="calendar-view" onclick="switchView('calendar-view')"><i class="fas fa-calendar-alt"></i> Calendar View</button>
    </nav>

    <div id="table-view" class="view active">
        <div class="table-responsive">
            <table class="task-table">
                <thead>
                <tr>
                    <th>ID</th>
                    <th>Title</th>
                    <th>Description</th>
                    <th>Due Date</th>
                    <th>Status</th>
                    <th>Priority</th>
                    <th>Actions</th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="task : ${tasks.content}">
                    <td th:text="${task.id}"></td>
                    <td th:text="${task.title}"></td>
                    <td th:text="${task.description}"></td>
                    <td th:text="${task.dueDate}"></td>
                    <td th:text="${task.status}"></td>
                    <td th:text="${task.priority}"></td>
                    <td>
                        <div class="action-buttons">
                            <a th:href="@{/tasks/view/{id}(id=${task.id})}" class="btn btn-view">View</a>
                            <a th:if="${task.status.name() != 'DONE'}" th:href="@{/tasks/edit/{id}(id=${task.id})}" class="btn btn-edit">Edit</a>
                            <a th:href="@{/tasks/delete/{id}(id=${task.id})}" class="btn btn-delete" onclick="return confirm('Delete task?')">Delete</a>
                            <a th:if="${task.status.name() != 'DONE'}" th:href="@{/tasks/markdown/{id}(id=${task.id})}" class="btn btn-mark-done">Mark Done</a>
                        </div>
                    </td>
                </tr>
                </tbody>
            </table>
        </div>
    </div>
    <div id="card-view" class="view">
        <div class="card-grid">
            <div class="flip-card" th:each="task : ${tasks.content}">
                <div class="flip-card-inner">
                    <!-- Front: Title and Description -->
                    <div class="flip-card-front" th:classappend="${task.priority != null} ? ' priority-' + ${#strings.toLowerCase(task.priority.name())} : ''">
                        <h2 th:text="${task.title}" style="margin: 0; font-size: 1.5em; color: #2c3e50; margin-bottom: 10px;"></h2>
                        <p style="color: #555; overflow: hidden; text-overflow: ellipsis; display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical;" th:text="${task.description}"></p>
                    </div>

                    <!-- Back: Action Buttons -->
                    <div class="flip-card-back">
                        <div class="action-buttons" style="flex-direction: column; gap: 10px; width: 80%; align-items: center;">
                            <a th:href="@{/tasks/view/{id}(id=${task.id})}" class="btn btn-view" style="width: 100%; text-align: center;">View</a>
                            <a th:if="${task.status.name() != 'DONE'}" th:href="@{/tasks/edit/{id}(id=${task.id})}" class="btn btn-edit" style="width: 100%; text-align: center;">Edit</a>
                            <a th:href="@{/tasks/delete/{id}(id=${task.id})}" class="btn btn-delete" onclick="return confirm('Delete task?')" style="width: 100%; text-align: center;">Delete</a>
                            <a th:if="${task.status.name() != 'DONE'}" th:href="@{/tasks/markdown/{id}(id=${task.id})}" class="btn btn-mark-done" style="width: 100%; text-align: center;">Mark Done</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div id="calendar-view" class="view">
        <!-- Calendar View -->
        <h3 style="text-align: center; margin-bottom: 20px;">ðŸ“… Calendar View</h3>
        <div class="calendar-grid-placeholder" style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; margin-top: 20px;">
            <!-- Day Headers -->
            <div style="font-weight: bold; text-align: center; background: #eee; padding: 10px;">Sun</div>
            <div style="font-weight: bold; text-align: center; background: #eee; padding: 10px;">Mon</div>
            <div style="font-weight: bold; text-align: center; background: #eee; padding: 10px;">Tue</div>
            <div style="font-weight: bold; text-align: center; background: #eee; padding: 10px;">Wed</div>
            <div style="font-weight: bold; text-align: center; background: #eee; padding: 10px;">Thu</div>
            <div style="font-weight: bold; text-align: center; background: #eee; padding: 10px;">Fri</div>
            <div style="font-weight: bold; text-align: center; background: #eee; padding: 10px;">Sat</div>

            <!-- Calendar Days (1-31) -->
            <div th:each="i : ${#numbers.sequence(1, 31)}" style="border: 1px solid #ddd; padding: 5px; min-height: 80px; background: #fff; position: relative;">
                <span th:text="${i}" style="font-weight: bold; display: block; margin-bottom: 5px; color: #999; font-size: 0.8em;"></span>
                
                <div th:each="task : ${tasks.content}">
                     <!-- Matching day logic (simplified) -->
                     <div th:if="${task.dueDate != null and #strings.endsWith(task.dueDate, '-' + #numbers.formatInteger(i, 2))}" 
                          style="margin-bottom: 2px;">
                         <a th:href="@{/tasks/view/{id}(id=${task.id})}"
                            style="display: block; font-size: 0.8em; color: #3498db; text-decoration: none; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;"
                            th:title="${task.title}">
                             <span th:text="${task.title}"></span>
                         </a>
                     </div>
                </div>
            </div>
        </div>
    </div>

    <div class="pagination-container" th:if="${totalPages > 0}" style="margin-top: 2rem; display: flex; justify-content: space-between; align-items: center; padding: 1rem; background: #f8f9fa; border-radius: 5px;">
        <div class="pagination-info">
            <span>Showing <span th:text="${tasks.number * tasks.size + 1}"></span> to 
                  <span th:text="${(tasks.number * tasks.size) + tasks.numberOfElements}"></span> of 
                  <span th:text="${tasks.totalElements}"></span> tasks</span>
        </div>
        
        <div class="pagination-controls" style="display: flex; gap: 0.5rem;">
            <!-- First Page -->
            <a th:if="${currentPage > 0}" 
               th:href="@{/tasks(page=0, size=${size}, keyword=${keyword}, status=${status}, priority=${priority}, dueDate=${dueDate})}"
               class="btn btn-pagination" title="First Page">
                <i class="fas fa-angle-double-left"></i>
            </a>
            
            <!-- Previous Page -->
            <a th:if="${currentPage > 0}"
               th:href="@{/tasks(page=${currentPage - 1}, size=${size}, keyword=${keyword}, status=${status}, priority=${priority}, dueDate=${dueDate})}"
               class="btn btn-pagination" title="Previous">
                <i class="fas fa-angle-left"></i>
            </a>

            <!-- Page Numbers -->
            <div class="page-numbers" style="display: flex; gap: 0.25rem;">
                <a th:each="i : ${#numbers.sequence(0, totalPages - 1)}"
                   th:if="${(i >= currentPage - 2 and i <= currentPage + 2) or i == 0 or i == totalPages - 1}"
                   th:classappend="${i == currentPage} ? 'active' : ''"
                   th:href="@{/tasks(page=${i}, size=${size}, keyword=${keyword}, status=${status}, priority=${priority}, dueDate=${dueDate})}"
                   class="btn btn-pagination"
                   th:text="${i + 1}">
                </a>
                <span class="ellipsis" th:if="${totalPages > 5 and currentPage < totalPages - 3}" style="align-self: center;">...</span>
            </div>

            <!-- Next Page -->
            <a th:if="${currentPage < totalPages - 1}"
               th:href="@{/tasks(page=${currentPage + 1}, size=${size}, keyword=${keyword}, status=${status}, priority=${priority}, dueDate=${dueDate})}"
               class="btn btn-pagination" title="Next">
                <i class="fas fa-angle-right"></i>
            </a>
            
            <!-- Last Page -->
            <a th:if="${currentPage < totalPages - 1}" 
               th:href="@{/tasks(page=${totalPages - 1}, size=${size}, keyword=${keyword}, status=${status}, priority=${priority}, dueDate=${dueDate})}"
               class="btn btn-pagination" title="Last Page">
                <i class="fas fa-angle-double-right"></i>
            </a>
        </div>
        
        <div class="page-size" style="display: flex; align-items: center; gap: 0.5rem;">
            <span>Tasks per page:</span>
            <select onchange="window.location.href=this.value" style="padding: 0.25rem;">
                <option th:each="s : ${pageSizes}"
                        th:value="@{/tasks(page=0, size=${s}, keyword=${keyword}, status=${status}, priority=${priority}, dueDate=${dueDate})}"
                        th:text="${s}"
                        th:selected="${s == size}">
                </option>
            </select>
        </div>
    </div>
</div>

<script th:src="@{/js/tasks.js}"></script>
</body>
</html>
